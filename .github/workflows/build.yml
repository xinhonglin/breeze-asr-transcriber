name: Build Cross-Platform Executables

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          # macOS Intel (x86_64)
          - os: macos-13
            python-version: '3.11'
            artifact_name: BreezASR-macOS-Intel
            arch: x86_64
            
          # macOS Apple Silicon (ARM64)
          - os: macos-14
            python-version: '3.11'
            artifact_name: BreezASR-macOS-ARM64
            arch: arm64
            
          # Windows x64
          - os: windows-latest
            python-version: '3.11'
            artifact_name: BreezASR-Windows
            arch: x64

    runs-on: ${{ matrix.os }}
    name: Build for ${{ matrix.artifact_name }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          version: "latest"
          python-version: ${{ matrix.python-version }}
          enable-cache: true

      - name: Install dependencies
        run: |
          uv sync
          uv pip install pyinstaller

      - name: Verify installation
        run: |
          uv run python -c "import torch, transformers, customtkinter; print('All dependencies installed successfully')"

      # ===== macOS 構建 =====
      - name: Build macOS .app bundle
        if: runner.os == 'macOS'
        run: |
          uv run pyinstaller \
            --name "BreezASR" \
            --windowed \
            --onedir \
            --icon=icon.icns \
            --hidden-import=torch \
            --hidden-import=torchaudio \
            --hidden-import=transformers \
            --hidden-import=customtkinter \
            --hidden-import=huggingface_hub \
            --collect-all customtkinter \
            --collect-submodules torch \
            --add-data "transcribe.py:." \
            --osx-bundle-identifier "com.github.xinhonglin.breezasr" \
            --noconfirm \
            gui.py

      - name: Verify macOS build
        if: runner.os == 'macOS'
        run: |
          ls -lh dist/
          echo "BreezASR.app has been generated"
          du -sh dist/BreezASR.app

      - name: Package macOS app
        if: runner.os == 'macOS'
        run: |
          cd dist
          zip -r -y "../BreezASR-${{ matrix.artifact_name }}.zip" BreezASR.app
          cd ..
          ls -lh BreezASR-*.zip

      # ===== Windows 構建 =====
      - name: Build Windows executable
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          uv run pyinstaller `
            --name "BreezASR" `
            --windowed `
            --onedir `
            --icon=icon.ico `
            --hidden-import=torch `
            --hidden-import=torchaudio `
            --hidden-import=transformers `
            --hidden-import=customtkinter `
            --hidden-import=huggingface_hub `
            --collect-all customtkinter `
            --collect-submodules torch `
            --add-data "transcribe.py;." `
            --noconfirm `
            gui.py

      - name: Verify Windows build
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Get-ChildItem dist\ -Recurse | Select-Object Name, Length
          Write-Output "BreezASR.exe has been generated"

      - name: Package Windows app
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Compress-Archive -Path dist\BreezASR -DestinationPath "BreezASR-${{ matrix.artifact_name }}.zip" -CompressionLevel Optimal
          Get-Item *.zip

      # ===== 上傳產物 =====
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: BreezASR-${{ matrix.artifact_name }}.zip
          retention-days: 30
          compression-level: 0

      # ===== 發布 Release =====
      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: BreezASR-${{ matrix.artifact_name }}.zip
          draft: false
          prerelease: false
          body: |
            # Breez ASR Transcriber ${{ github.ref_name }}
            
            ## Download Instructions
            
            - **macOS Intel**: For Intel-based Macs (x86_64)
            - **macOS ARM64**: For Apple Silicon Macs (M1/M2/M3/M4)
            - **Windows**: For Windows 10/11 (64-bit)
            
            ## Installation Steps
            
            ### macOS
            1. Download the appropriate `.zip` file
            2. Extract and drag `BreezASR.app` to Applications folder
            3. Right-click and select "Open" on first launch (bypass Gatekeeper)
            4. First run will download language models (~1.5GB, takes a few minutes)
            
            ### Windows
            1. Download the Windows `.zip` file
            2. Extract to any location
            3. Run `BreezASR.exe` inside the BreezASR folder
            4. First run will download language models (~1.5GB, takes a few minutes)
            
            ## System Requirements
            
            - **macOS**: 12 Monterey or later
            - **Windows**: 10/11 (64-bit)
            - **RAM**: At least 4GB (8GB recommended)
            - **Storage**: At least 3GB (for model cache)
            
            ## Known Issues
            
            - macOS first launch may be slow (model loading)
            - Windows Defender may flag as false positive (add to whitelist)
            
            ---
            
            Full documentation: [README.md](https://github.com/${{ github.repository }})
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Build success
        shell: bash
        run: echo "Build completed successfully for ${{ matrix.artifact_name }}"