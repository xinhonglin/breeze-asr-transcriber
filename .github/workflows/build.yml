name: Build Cross-Platform Executables

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          # macOS Intel (x86_64)
          - os: macos-13
            python-version: '3.11'
            artifact_name: BreezASR-macOS-Intel
            arch: x86_64
            
          # macOS Apple Silicon (ARM64)
          - os: macos-14
            python-version: '3.11'
            artifact_name: BreezASR-macOS-ARM64
            arch: arm64
            
          # Windows x64
          - os: windows-latest
            python-version: '3.11'
            artifact_name: BreezASR-Windows
            arch: x64

    runs-on: ${{ matrix.os }}
    name: Build for ${{ matrix.artifact_name }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          version: "latest"
          python-version: ${{ matrix.python-version }}
          enable-cache: true

      - name: Install dependencies
        run: |
          uv sync
          uv pip install pyinstaller

      - name: Verify installation
        run: |
          uv run python -c "import torch, transformers, customtkinter; print('âœ“ All dependencies installed')"

      # ===== macOS æ§‹å»º =====
      - name: Build macOS .app bundle
        if: runner.os == 'macOS'
        run: |
          uv run pyinstaller \
            --name "BreezASR" \
            --windowed \
            --onedir \
            --icon=icon.icns \
            --hidden-import=torch \
            --hidden-import=torchaudio \
            --hidden-import=transformers \
            --hidden-import=customtkinter \
            --hidden-import=huggingface_hub \
            --collect-all customtkinter \
            --collect-submodules torch \
            --add-data "transcribe.py:." \
            --osx-bundle-identifier "com.github.xinhonglin.breezasr" \
            --noconfirm \
            gui.py

      - name: Verify macOS build
        if: runner.os == 'macOS'
        run: |
          ls -lh dist/
          echo "ğŸ“¦ BreezASR.app å·²ç”Ÿæˆ"
          du -sh dist/BreezASR.app

      - name: Package macOS app
        if: runner.os == 'macOS'
        run: |
          cd dist
          zip -r "../BreezASR-${{ matrix.artifact_name }}.zip" BreezASR.app
          cd ..
          ls -lh BreezASR-*.zip

      # ===== Windows æ§‹å»º =====
      - name: Build Windows executable
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          uv run pyinstaller `
            --name "BreezASR" `
            --windowed `
            --onedir `
            --icon=icon.ico `
            --hidden-import=torch `
            --hidden-import=torchaudio `
            --hidden-import=transformers `
            --hidden-import=customtkinter `
            --hidden-import=huggingface_hub `
            --collect-all customtkinter `
            --collect-submodules torch `
            --add-data "transcribe.py;." `
            --noconfirm `
            gui.py

      - name: Verify Windows build
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Get-ChildItem dist\ -Recurse | Select-Object Name, Length
          Write-Host "ğŸ“¦ BreezASR.exe å·²ç”Ÿæˆ"

      - name: Package Windows app
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Compress-Archive -Path dist\BreezASR -DestinationPath "BreezASR-${{ matrix.artifact_name }}.zip" -CompressionLevel Optimal
          Get-Item *.zip

      # ===== ä¸Šå‚³ç”¢ç‰© =====
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: BreezASR-${{ matrix.artifact_name }}.zip
          retention-days: 30
          compression-level: 0  # å·²ç¶“æ˜¯ zipï¼Œä¸éœ€è¦å†å£“ç¸®

      # ===== ç™¼å¸ƒ Release =====
      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: BreezASR-${{ matrix.artifact_name }}.zip
          draft: false
          prerelease: false
          body: |
            # ğŸ™ï¸ Breez ASR Transcriber ${{ github.ref_name }}
            
            ## ğŸ“¥ ä¸‹è¼‰èªªæ˜
            
            - **macOS Intel**: é©ç”¨æ–¼ Intel æ™¶ç‰‡ Mac (x86_64)
            - **macOS ARM64**: é©ç”¨æ–¼ Apple Silicon Mac (M1/M2/M3/M4)
            - **Windows**: é©ç”¨æ–¼ Windows 10/11 (64-bit)
            
            ## ğŸš€ å®‰è£æ­¥é©Ÿ
            
            ### macOS
            1. ä¸‹è¼‰å°æ‡‰ç‰ˆæœ¬çš„ `.zip` æª”æ¡ˆ
            2. è§£å£“ç¸®å¾Œå°‡ `BreezASR.app` æ‹–æ›³åˆ°ã€Œæ‡‰ç”¨ç¨‹å¼ã€è³‡æ–™å¤¾
            3. é¦–æ¬¡é–‹å•Ÿæ™‚ï¼Œå³éµé»æ“Šé¸æ“‡ã€Œæ‰“é–‹ã€ï¼ˆç¹é Gatekeeperï¼‰
            4. é¦–æ¬¡åŸ·è¡Œæœƒè‡ªå‹•ä¸‹è¼‰èªè¨€æ¨¡å‹ï¼ˆç´„ 1.5GBï¼Œéœ€æ•¸åˆ†é˜ï¼‰
            
            ### Windows
            1. ä¸‹è¼‰ Windows ç‰ˆæœ¬çš„ `.zip` æª”æ¡ˆ
            2. è§£å£“ç¸®åˆ°ä»»æ„ä½ç½®
            3. åŸ·è¡Œ `BreezASR.exe`
            4. é¦–æ¬¡åŸ·è¡Œæœƒè‡ªå‹•ä¸‹è¼‰èªè¨€æ¨¡å‹ï¼ˆç´„ 1.5GBï¼Œéœ€æ•¸åˆ†é˜ï¼‰
            
            ## ğŸ’» ç³»çµ±éœ€æ±‚
            
            - **macOS**: 12 Monterey æˆ–æ›´æ–°ç‰ˆæœ¬
            - **Windows**: 10/11 (64-bit)
            - **RAM**: è‡³å°‘ 4GBï¼ˆå»ºè­° 8GBï¼‰
            - **å„²å­˜ç©ºé–“**: è‡³å°‘ 3GBï¼ˆç”¨æ–¼æ¨¡å‹å¿«å–ï¼‰
            
            ## ğŸ› å·²çŸ¥å•é¡Œ
            
            - macOS é¦–æ¬¡å•Ÿå‹•å¯èƒ½è¼ƒæ…¢ï¼ˆæ¨¡å‹è¼‰å…¥ï¼‰
            - Windows Defender å¯èƒ½èª¤å ±ï¼ˆè«‹åŠ å…¥ç™½åå–®ï¼‰
            
            ---
            
            å®Œæ•´èªªæ˜è«‹åƒè€ƒ [README.md](https://github.com/${{ github.repository }})
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Build success
        run: echo "âœ… Build completed for ${{ matrix.artifact_name }}"